(function(a){a.fileman={items:{},curr:[],indialog:!1,init:function(c){try{this.init_templates(),a(c).html(this.templates.tabs),a("#posteditor-files-tabs").tabs({cache:!0,select:function(b,c){try{"empty"==a(c.panel).data("files")&&a.fileman.loadpage(c.panel,a(c.panel).data("page"))}catch(f){alert("error "+f.message)}}}),a.litejson({method:"files_getpost",idpost:ltoptions.idpost},function(b){try{a.fileman.set_tabs_count(b.count);for(var c in b.files)a.fileman.curr.push(c),a.fileman.items[c]=b.files[c];
a.fileman.setpage("#current-files",b.files);a.fileman.setpage("#new-files",[])}catch(f){alert("error "+f.message)}}).fail(function(a){alert(a.responseText)}),ltoptions.swfu=createswfu(a.fileman.uploaded),a("form:first").submit(function(){a("input[name='files']").val(a.fileman.curr.join(","))})}catch(b){alert("error "+b.message)}},init_templates:function(){var c={lang:lang.posteditor,iconurl:ltoptions.files+"/js/litepublisher/icons/"},b;for(b in this.templates)this.templates[b]=a.simpletml(this.templates[b],
c)},set_tabs_count:function(c){if(!(1>c))for(var b=a("#posteditor-files-tabs"),d=1;d<=c;d++)a(this.templates.tab.replace("{{index}}",d)).appendTo(b).data("page",d).data("files","empty"),b.tabs("add","#filepage-"+d,d)},setpage:function(c,b){var d=a(c),e;for(e in b)0==parseInt(b[e].parent)&&d.append(this.get_fileitem(e));d.on("click",".file-toolbar a",function(){var b=a(this).closest(".file-item"),c=b.data("idfile");switch(a(this).attr("class")){case "add-toolbutton":a.fileman.add(c);break;case "delete-toolbutton":a.fileman.del(c,
b);break;case "property-toolbutton":a.fileman.editprops(c,b)}return!1})},get_fileitem:function(c){var b=this.items[c];b.link=ltoptions.files+"/files/"+b.filename;type=b.media in this.templates?b.media:"file";b.previewlink="";0!=parseInt(b.preview)&&b.preview in this.items&&(b.previewlink=ltoptions.files+"/files/"+this.items[b.preview].filename);b=a.simpletml(this.templates.item,{id:b.id,content:a.simpletml(this.templates[type],b)});return a(b).data("idfile",c)},loadpage:function(c,b){a(c).data("files",
"loading");a.litejson({method:"files_getpage",page:b-1},function(b){a.fileman.joinitems(b.files);a.fileman.setpage(c,b.files)}).fail(function(b){a.messagebox(lang.dialog.error,b.responseText)})},joinitems:function(a){for(var b in a)this.items[b]=a[b]},uploaded:function(c,b){alert(b);try{var d=a.parseJSON(b),e=d.id;a.fileman.curr.push(e);a.fileman.items[e]=d.item;0!=d.item.preview&&(a.fileman.items[d.preview.id]=d.preview);a("#current-files").append(a.fileman.get_fileitem(e));a("#new-files").append(a.fileman.get_fileitem(e))}catch(f){alert("error "+
f.message)}},add:function(c){0<=a.inArray(c,this.curr)||(this.curr.push(c),a("#current-files").append(this.get_fileitem(c)))},del:function(c,b){var d=a.inArray(c,this.curr);0>d||(delete this.curr[d],b.remove())},editprops:function(c,b){if(this.indialog)return!1;this.indialog=!0;var d=this.items[c];a.prettyPhotoDialog({title:lang.posteditor.property,html:this.templates.fileprops,open:function(b){a("input[name='fileprop-title']",b).val(d.title);a("input[name='fileprop-description']",b).val(d.description);
a("input[name='fileprop-keywords']",b).val(d.keywords)},buttons:[{title:"Ok",click:function(){var d=a(".pp_inline"),f=a.trim(a("input[name='fileprop-title']",d).val()),g=a.trim(a("input[name='fileprop-description']",d).val()),d=a.trim(a("input[name='fileprop-keywords']",d).val());a.prettyPhoto.close();a.fileman.setprops(c,f,g,d,b)}},{title:lang.dialog.cancel,click:function(){a.prettyPhoto.close();a.fileman.indialog=!1}}]})},setprops:function(c,b,d,e,f){a.litejsontype("post",{method:"files_setprops",
idfile:c,title:b,description:d,keywords:e},function(b){a.fileman.items[b.item.id]=b.item;f.replaceWith(a.fileman.get_fileitem(c));a.fileman.indialog=!1}).fail(function(b){a.fileman.indialog=!1;a.messagebox(lang.dialog.error,b.responseText)})}}})(jQuery);
