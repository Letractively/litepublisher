(function(a){a.fileman={items:{},curr:[],indialog:!1,init:function(b){this.init_templates();a(b).html(this.templates.tab);a("#posteditor-files-tabs").tabs({cache:!0,select:function(b,c){"empty"==a(c.panel).data("files")&&a.fileman.loadpage(c.panel,a(c.panel).data("page"))}});a.litejson({method:"files_getpost",idpost:ltoptions.idpost},function(b){a.fileman.set_tabs_count(b.count);for(var c in b.files)a.fileman.curr.push(c),a.fileman.items[c]=b.files[c];$fileman.setpage("#current-files",b.files);$fileman.setpage("#new-files",
[])}).fail(function(b){a.messagebox(lang.dialog.error,b.responseText)});ltoptions.swfu=createswfu(a.fileman.uploaded);a("form:first").submit(function(){a("input[name='files']").val(a.fileman.curr.join(","))})},init_templates:function(){var a={lang:lang.posteditor,iconurl:ltoptions.files+"/js/litepublisher/icons/"},d;for(d in this.templates)this.templates[d]=Mustache.render(this.templates[d],a)},set_tabs_count:function(b){if(!(1>b))for(var d=a("#posteditor-files-tabs"),c=1;c<=b;c++)a(this.templates.tab.replace("{{index}}",
c)).appendTo(d).data("page",c).data("files","empty"),d.tabs("add","#filepage-"+c,c)},setpage:function(b,d){var c=a(b),e;for(e in d)0==parseInt(fileitem.parent)&&c.append(this.get_fileitem(e));c.on("click",".toolbar a",function(){var b=a(this).closest(".file-item"),c=b.data("idfile");switch(a(this).attr("class")){case "add-toolbutton":a.fileman.add(c);break;case "delete-toolbutton":a.fileman.del(c,b);break;case "property-toolbutton":a.fileman.editprops(c,b)}return!1})},get_fileitem:function(b){b=this.files[b];
b.link=ltoptions.files+"/files/"+b.url;type=b.type in this.templates?b.type:"file";0!=parseInt(b.preview)&&(b.previewlink=ltoptions.files+"/files/"+this.files[b.preview].url);b=Mustache.render(this.templates.item,{id:b.id,content:Mustache.render(this.templates[type],b)});return a(b).data("idfile",idfile)},loadpage:function(b,d){a(b).data("files","loading");a.litejson({method:"files_getpage",page:d-1},function(c){a.fileman.joinitems(c.files);a.fileman.setpage(b,c.files)}).fail(function(b){a.messagebox(lang.dialog.error,
b.responseText)})},joinitems:function(a){for(var d in a)this.items[d]=a[d]},uploaded:function(b,d){var c=a.parseJSON(d),e=c.id;a.fileman.curr.push(e);a.fileman.items[e]=c.item;0!=c.item.preview&&(a.fileman.items[c.preview.id]=c.preview);a("#current-files").append(a.fileman.get_fileitem(e));a("#new-files").append(a.fileman.get_fileitem(e))},add:function(b){0<=a.inArray(b,this.curr)||(this.curr.push(b),a("#current-files").append(this.get_fileitem(b)))},del:function(b,d){var c=a.inArray(b,this.curr);
0>c||(delete this.curr[c],d.remove())},editprops:function(b,d){if(this.indialog)return!1;this.indialog=!0;var c=this.items[b];a.prettyPhotoDialog({title:lang.posteditor.property,html:this.templates.fileprops,open:function(b){a("input[name='fileprop-title']",b).val(c.title);a("input[name='fileprop-description']",b).val(c.description);a("input[name='fileprop-keywords']",b).val(c.keywords)},buttons:[{title:"Ok",click:function(){var c=a(".pp_inline"),f=a.trim(a("input[name='fileprop-title']",c).val()),
g=a.trim(a("input[name='fileprop-description']",c).val()),c=a.trim(a("input[name='fileprop-keywords']",c).val());a.prettyPhoto.close();a.fileman.setprops(b,f,g,c,d)}},{title:lang.dialog.cancel,click:function(){a.prettyPhoto.close();a.fileman.indialog=!1}}]})},setprops:function(b,d,c,e,f){a.litejsontype("post",{method:"files_setprops",idfile:b,title:d,description:c,keywords:e},function(c){a.fileman.items[c.item.id]=c.item;f.replaceWith(a.fileman.get_fileitem(b));a.fileman.indialog=!1}).fail(function(b){a.fileman.indialog=
!1;a.messagebox(lang.dialog.error,b.responseText)})}}})(jQuery);
