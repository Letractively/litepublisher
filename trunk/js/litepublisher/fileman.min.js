(function(b){litepubl.Fileman=Class.extend({items:{},curr:[],indialog:!1,init:function(d){try{this.init_templates();var a=this;b(d).html(this.tml.tabs);b("#posteditor-files-tabs").tabs({cache:!0,select:function(d,c){"empty"==b(c.panel).data("files")&&a.loadpage(c.panel,b(c.panel).data("page"))}});this.load_current_files();ltoptions.swfu=createswfu(function(b,d){a.uploaded(b,d)});b("form:first").submit(function(){b("input[name='files']").val(a.curr.join(","))})}catch(c){alert("error "+c.message)}},
init_templates:function(){this.tml=litepubl.tml.fileman;b.replacetml(litepubl.tml.fileman,{lang:lang.posteditor,iconurl:ltoptions.files+"/js/litepublisher/icons/"})},load_current_files:function(){var d=this;b.litejson({method:"files_getpost",idpost:ltoptions.idpost},function(b){try{d.set_uploaded(b)}catch(c){alert("error "+c.message)}}).fail(function(a){b.messagebox(lang.dialog.error,a.responseText)})},set_uploaded:function(d){"fileperm"in d&&b("#posteditor-fileperms").html(d.fileperm);this.set_tabs_count(d.count);
for(var a in d.files)this.curr.push(a),this.items[a]=d.files[a];this.setpage("#current-files",d.files);this.setpage("#new-files",{})},set_tabs_count:function(d){if(!(1>d))for(var a=b("#posteditor-files-tabs"),c=1;c<=d;c++)b(this.tml.tab.replace("{{index}}",c)).appendTo(a).data("page",c).data("files","empty"),a.tabs("add","#filepage-"+c,c)},setpage:function(d,a){var c=b(".file-items",d),e;for(e in a)0==parseInt(a[e].parent)&&c.append(this.get_fileitem(e));this.setborders(c);var f=this;c.on("click.toolbar",
".file-toolbar a",function(){var a=b(this).closest(".file-item"),d=a.data("idfile");switch(b(this).attr("class")){case "add-toolbutton":f.add(d);break;case "delete-toolbutton":f.del(d,a);break;case "property-toolbutton":f.editprops(d,a)}return!1});c.on("click.image","a.file-image",function(){var a=b(this);b.prettyPhoto.open(a.attr("href"),a.attr("title"),b("img",a).attr("alt"));return!1})},get_fileitem:function(d){var a=this.items[d];a.link=ltoptions.files+"/files/"+a.filename;type=a.media in this.tml?
a.media:"file";a.previewlink="";0!=parseInt(a.preview)&&a.preview in this.items&&(a.previewlink=ltoptions.files+"/files/"+this.items[a.preview].filename);a=b.simpletml(this.tml.item,{id:a.id,content:b.simpletml(this.tml[type],a)});return b(a).data("idfile",d)},loadpage:function(d,a){var c=this;b(d).data("files","loading");b.litejson({method:"files_getpage",page:a-1},function(a){c.joinitems(a.files);c.setpage(d,a.files)}).fail(function(a){b.messagebox(lang.dialog.error,a.responseText)})},joinitems:function(b){for(var a in b)this.items[a]=
b[a]},uploaded:function(d,a){try{var c=b.parseJSON(a),e=c.id;this.curr.push(e);this.items[e]=c.item;0!=c.item.preview&&(this.items[c.preview.id]=c.preview);b("#current-files .file-items").append(this.get_fileitem(e));b("#new-files .file-items").append(this.get_fileitem(e))}catch(f){alert("error "+f.message)}},setborders:function(d){var a=b(".file-item",d);if(0!=a.length){a.removeClass("border-left");var c=b(".file-item:first",d).position();a.each(function(){var a=b(this);a.position().left==c.left&&
a.addClass("border-left")})}},add:function(d){0<=b.inArray(d,this.curr)||(this.curr.push(d),this.setborders(b("#current-files .file-items").append(this.get_fileitem(d))))},del:function(d,a){var c=b.inArray(d,this.curr);0>c||(delete this.curr[c],c=a.parent(),a.remove(),this.setborders(c))},editprops:function(d,a){if(this.indialog)return!1;this.indialog=!0;var c=this.items[d],e=this;b.prettyPhotoDialog({title:lang.posteditor.property,html:this.tml.fileprops,open:function(a){b("input[name='fileprop-title']",
a).val(c.title);b("input[name='fileprop-description']",a).val(c.description);b("input[name='fileprop-keywords']",a).val(c.keywords)},buttons:[{title:"Ok",click:function(){var c=b(".pp_inline"),g=b.trim(b("input[name='fileprop-title']",c).val()),h=b.trim(b("input[name='fileprop-description']",c).val()),c=b.trim(b("input[name='fileprop-keywords']",c).val());b.prettyPhoto.close();e.setprops(d,g,h,c,a)}},{title:lang.dialog.cancel,click:function(){b.prettyPhoto.close();e.indialog=!1}}]})},setprops:function(d,
a,c,e,f){var g=this;b.litejsonpost({method:"files_setprops",idfile:d,title:a,description:c,keywords:e},function(a){g.items[a.item.id]=a.item;f.replaceWith(g.get_fileitem(d));g.indialog=!1}).fail(function(a){g.indialog=!1;b.messagebox(lang.dialog.error,a.responseText)})}})})(jQuery,document,window);
