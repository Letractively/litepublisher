(function(a,m,n){litepubl.Moderate=Class.extend({enabled:!0,init:function(b){this.options=a.extend({comments:"#commentlist",hold:"#holdcommentlist",comment:"#comment-",content:"#commentcontent-",buttons:".moderationbuttons",button:'<button type="button" class="button"><span>%%title%%</span></button>',form:"#commentform"},ltoptions.theme.comments,b);this.onbuttons=a.Callbacks();this.create_buttons(this.options.comments+", "+this.options.hold);a(".loadhold").click(this.loadhold)},setenabled:function(b){b!=
this.enabled&&((this.enabled=b)?a(this.options.buttons).show():a(this.options.buttons).hide())},getarea:function(){return a("textarea:first",this.options.form)},error:function(b){this.setenabled(!0);a.messagebox(lang.dialog.error,b)},setstatus:function(b,c){var d=this,e=this.options,f=e.comment+b;switch(c){case "delete":this.setenabled(!1);a.confirmbox(lang.dialog.confirm,lang.comments.confirmdelete,lang.comments.yesdelete,lang.comments.nodelete,function(c){if(0!=c)return d.setenabled(!0);a.litejson({method:"comment_delete",
id:b},function(c){if(!1==c)return d.error(lang.comments.notdeleted);a(f).remove();d.setenabled(!0)}).fail(function(a,c,b){d.error(lang.comments.notdeleted)})});break;case "hold":case "approved":this.setenabled(!1);a.litejson({method:"comment_setstatus",id:b,status:c},function(f){try{if(!1==f)return d.error(lang.comments.notmoderated);a("hold"==c?e.hold:e.comments).append(a(e.comment+b));d.setenabled(!0)}catch(k){erralert(k)}}).fail(function(a,c,b){d.error(lang.comments.notmoderated)});break;case "edit":this.setenabled(!1);
a.litejson({method:"comment_getraw",id:b},function(a){try{d.edit(b,a.rawcontent)}catch(c){erralert(c)}}).fail(function(a,c,b){d.error(lang.comments.errorrecieved)});break;default:alert("Unknown status "+c)}},edit:function(b,c){var d=this.getarea();d.data("idcomment",b).data("savedtext",d.val()).val(c).focus();a.onEscape(this.restore_submit);var e=this,f=a(this.options.form);f.off("submit.confirmcomment").on("submit.moderate",function(){try{var c=a.trim(d.val());if(""==c)return e.enabled=!0,e.error(lang.comment.emptycontent),
e.enabled=!1;a(":input",f).attr("disabled","disabled");a.litejsonpost({method:"comment_edit",id:d.data("idcomment"),content:c},function(c){try{a(":input",f).removeAttr("disabled");var b=e.options.content+c.id;a(b).html(c.content);e.restore_submit();location.hash=b.substring(1)}catch(d){erralert(d)}}).fail(function(c,b,d){a(":input",f).removeAttr("disabled");e.error(lang.comments.notedited);e.restore_submit()})}catch(b){erralert(b)}return!1})},restore_submit:function(){var b=this.getarea();b.val(b.data("savedtext"));
this.setenabled(!0);a(this.options.form).off("submit.moderate").on("submit.confirmcomment",function(){if("confirmcomment"in litepubl)return litepubl.confirmcomment.submit()})},loadhold:function(){var b=this,c=this.options;a(".loadhold").parent().remove();a.litejson({method:"comments_get_hold",idpost:ltoptions.idpost},function(d){try{if(c.ismoder){for(var e=a(c.comments),f=a(c.hold);e.next()[0]!=f[0];)e.next().remove();f.remove()}a(c.comments).after(d.items);b.create_buttons(c.hold)}catch(l){erralert(l)}}).fail(function(a,
c,f){b.error(lang.comments.errorrecieved)});return!1},create_buttons:function(b){var c=this.options,d=c.button.replace("%%title%%",lang.comments.approve).replace("%%name%%","approve"),e=c.button.replace("%%title%%",lang.comments.hold).replace("%%name%%","hold"),f=c.button.replace("%%title%%",lang.comments.del).replace("%%name%%","delete"),l=c.button.replace("%%title%%",lang.comments.edit).replace("%%name%%","edit"),k=this,g=function(){if(!k.enabled)return!1;var c=a(this);k.setstatus(c.data("idcomment"),
c.data("moder"));return!1},m=litepubl.getuser().id;a(c.buttons,b).each(function(){var b=a(this),h=b.data("idcomment");if(c.ismoder){if(a(d).appendTo(b).data("idcomment",h).data("moder","approved").click(g),a(e).appendTo(b).data("idcomment",h).data("moder","hold").click(g),a(f).appendTo(b).data("idcomment",h).data("moder","delete").click(g),a(l).appendTo(b).data("idcomment",h).data("moder","edit").click(g),b.is(":hidden"))a('<button type="button">E</button>').insertBefore(b).one("click",function(){a(this).next().show();
a(this).remove();return!1})}else if(parseInt(b.data("idauthor"))==m&&(c.canedit&&a(l).appendTo(b).data("idcomment",h).data("moder","edit").click(g),c.candelete&&a(f).appendTo(b).data("idcomment",h).data("moder","delete").click(g),(c.canedit||c.candelete)&&b.is(":hidden")))a('<button type="button">E</button>').insertBefore(b).one("click",function(){a(this).next().show();a(this).remove();return!1});k.onbuttons.fire(b)})}});a(m).ready(function(){litepubl.getuser().id&&litepubl.newinstance("moderate",
litepubl.Moderate)})})(jQuery,document,window);
