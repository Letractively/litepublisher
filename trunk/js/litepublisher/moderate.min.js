(function(a,j){litepubl.Moderate=Class.extend({enabled:!0,init:function(b){this.options=a.extend({comments:"#commentlist",hold:"#holdcommentlist",comment:"#comment-",content:"#commentcontent-",buttons:".moderationbuttons",button:'<button type="button">%%title%%</button>',form:"#commentform"},ltoptions.theme.comments,b);this.create_buttons(this.options.comments+", "+this.options.hold);a(".loadhold").click(this.loadhold)},setenabled:function(b){b!=this.enabled&&((this.enabled=b)?a(this.options.buttons).show():
a(this.options.buttons).hide())},getarea:function(){return a("textarea:first",this.options.form)},error:function(b){this.setenabled(!0);a.messagebox(lang.dialog.error,b)},setstatus:function(b,c){var d=this,f=this.options,h=f.comment+b;switch(c){case "delete":this.setenabled(!1);a.confirmbox(lang.dialog.confirm,lang.comments.confirmdelete,lang.comments.yesdelete,lang.comments.nodelete,function(c){if(0!=c)return d.setenabled(!0);a.litejson({method:"comment_delete",id:b},function(c){if(!1==c)return d.error(lang.comments.notdeleted);
a(h).remove();d.setenabled(!0)}).fail(function(){d.error(lang.comments.notdeleted)})});break;case "hold":case "approved":d.setenabled(!1);a.litejson({method:"comment_setstatus",id:b,status:c},function(i){try{if(!1==i)return d.error(lang.comments.notmoderated);a("hold"==c?f.hold:f.comments).append(a(f.comment+b));d.setenabled(!0)}catch(e){alert("error "+e.message)}}).fail(function(){d.error(lang.comments.notmoderated)});break;case "edit":d.setenabled(!1);a.litejson({method:"comment_getraw",id:b},function(c){var e=
d.getarea();e.data("idcomment",b);e.data("savedtext",e.val());e.val(c.rawcontent);e.focus();a.onEscape(d.restore_submit);var g=a(f.form);g.off("submit.confirmcomment").on("submit.moderate",function(){try{var c=d.getarea(),b=a.trim(c.val());if(""==b)return d.enabled=!0,d.error(lang.comment.emptycontent),d.enabled=!1;a(":input",g).attr("disabled","disabled");a.litejsonpost({method:"comment_edit",id:c.data("idcomment"),content:b},function(c){try{a(":input",g).removeAttr("disabled");var b=f.content+c.id;
a(b).html(c.content);d.restore_submit();location.hash=b.substring(1)}catch(k){alert(k.message)}}).fail(function(){a(":input",g).removeAttr("disabled");d.error(lang.comments.notedited);d.restore_submit()})}catch(e){alert(e.message)}return!1})}).fail(function(){d.error(lang.comments.errorrecieved)});break;default:alert("Unknown status "+c)}},restore_submit:function(){var b=this.getarea();b.val(b.data("savedtext"));this.setenabled(!0);a(this.options.form).off("submit.moderate").on("submit.confirmcomment",
function(){if("confirmcomment"in litepubl)return litepubl.confirmcomment.submit()})},loadhold:function(){var b=this,c=this.options;a(".loadhold").parent().remove();a.litejson({method:"comments_get_hold",idpost:ltoptions.idpost},function(d){try{if(c.ismoder){for(var f=a(c.comments),h=a(c.hold);f.next()[0]!=h[0];)f.next().remove();h.remove()}a(c.comments).after(d.items);b.create_buttons(c.hold)}catch(i){alert("error "+i.message)}}).fail(function(){b.error(lang.comments.errorrecieved)});return!1},create_buttons:function(b){var c=
this.options,d=c.button.replace("%%title%%",lang.comments.approve),f=c.button.replace("%%title%%",lang.comments.hold),h=c.button.replace("%%title%%",lang.comments.del),i=c.button.replace("%%title%%",lang.comments.edit),e=this,g=function(){if(!e.enabled)return!1;var c=a(this);e.setstatus(c.data("idcomment"),c.data("moder"));return!1},j=get_cookie("litepubl_user_id");a(c.buttons,b).each(function(){var b=a(this),e=b.data("idcomment");if(c.ismoder){if(a(d).appendTo(b).data("idcomment",e).data("moder",
"approved").click(g),a(f).appendTo(b).data("idcomment",e).data("moder","hold").click(g),a(h).appendTo(b).data("idcomment",e).data("moder","delete").click(g),a(i).appendTo(b).data("idcomment",e).data("moder","edit").click(g),b.is(":hidden"))a('<button type="button">E</button>').insertBefore(b).one("click",function(){a(this).next().show();a(this).remove();return!1})}else if(b.data("idauthor")==j&&(c.canedit&&a(i).appendTo(b).data("idcomment",e).data("moder","edit").click(g),c.candelete&&a(h).appendTo(b).data("idcomment",
e).data("moder","delete").click(g),(c.canedit||c.candelete)&&b.is(":hidden")))a('<button type="button">E</button>').insertBefore(b).one("click",function(){a(this).next().show();a(this).remove();return!1})})}});a(j).ready(function(){get_cookie("litepubl_user_id")&&(litepubl.moderate=new litepubl.Moderate)})})(jQuery,document,window);
