(function(a,m,n){litepubl.Moderate=Class.extend({enabled:!0,init:function(c){this.options=a.extend({comments:"#commentlist",hold:"#holdcommentlist",comment:"#comment-",content:"#commentcontent-",buttons:".moderationbuttons",button:'<button type="button" class="button"><span>%%title%%</span></button>',form:"#commentform"},ltoptions.theme.comments,c);this.onbuttons=a.Callbacks();a(".loadhold").click(this.loadhold);var b=this;n.setTimeout(function(){b.create_buttons(b.options.comments+", "+b.options.hold)},
20)},setenabled:function(c){c!=this.enabled&&((this.enabled=c)?a(this.options.buttons).show():a(this.options.buttons).hide())},getarea:function(){return a("textarea:first",this.options.form)},error:function(c){this.setenabled(!0);a.messagebox(lang.dialog.error,c)},setstatus:function(c,b){var d=this,e=this.options,f=e.comment+c;switch(b){case "delete":this.setenabled(!1);a.confirmbox(lang.dialog.confirm,lang.comments.confirmdelete,lang.comments.yesdelete,lang.comments.nodelete,function(b){if(0!=b)return d.setenabled(!0);
a.litejson({method:"comment_delete",id:c},function(b){if(!1==b)return d.error(lang.comments.notdeleted);a(f).remove();d.setenabled(!0)}).fail(function(a,b,c){d.error(lang.comments.notdeleted)})});break;case "hold":case "approved":this.setenabled(!1);a.litejson({method:"comment_setstatus",id:c,status:b},function(f){try{if(!1==f)return d.error(lang.comments.notmoderated);a("hold"==b?e.hold:e.comments).append(a(e.comment+c));d.setenabled(!0)}catch(k){erralert(k)}}).fail(function(a,b,c){d.error(lang.comments.notmoderated)});
break;case "edit":this.setenabled(!1);a.litejson({method:"comment_getraw",id:c},function(a){try{d.edit(c,a.rawcontent)}catch(b){erralert(b)}}).fail(function(a,b,c){d.error(lang.comments.errorrecieved)});break;default:alert("Unknown status "+b)}},edit:function(c,b){var d=this.getarea();d.data("idcomment",c).data("savedtext",d.val()).val(b).focus();a.onEscape(this.restore_submit);var e=this,f=a(this.options.form);f.off("submit.confirmcomment").on("submit.moderate",function(){try{var b=a.trim(d.val());
if(""==b)return e.enabled=!0,e.error(lang.comment.emptycontent),e.enabled=!1;a(":input",f).attr("disabled","disabled");a.litejsonpost({method:"comment_edit",id:d.data("idcomment"),content:b},function(b){try{a(":input",f).removeAttr("disabled");var c=e.options.content+b.id;a(c).html(b.content);e.restore_submit();location.hash=c.substring(1)}catch(d){erralert(d)}}).fail(function(b,c,d){a(":input",f).removeAttr("disabled");e.error(lang.comments.notedited);e.restore_submit()})}catch(c){erralert(c)}return!1})},
restore_submit:function(){var c=this.getarea();c.val(c.data("savedtext"));this.setenabled(!0);a(this.options.form).off("submit.moderate").on("submit.confirmcomment",function(){if("confirmcomment"in litepubl)return litepubl.confirmcomment.submit()})},loadhold:function(){var c=this,b=this.options;a(".loadhold").parent().remove();a.litejson({method:"comments_get_hold",idpost:ltoptions.idpost},function(d){try{if(b.ismoder){for(var e=a(b.comments),f=a(b.hold);e.next()[0]!=f[0];)e.next().remove();f.remove()}a(b.comments).after(d.items);
c.create_buttons(b.hold)}catch(l){erralert(l)}}).fail(function(a,b,f){c.error(lang.comments.errorrecieved)});return!1},create_buttons:function(c){var b=this.options,d=b.button.replace("%%title%%",lang.comments.approve).replace("%%name%%","approve"),e=b.button.replace("%%title%%",lang.comments.hold).replace("%%name%%","hold"),f=b.button.replace("%%title%%",lang.comments.del).replace("%%name%%","delete"),l=b.button.replace("%%title%%",lang.comments.edit).replace("%%name%%","edit"),k=this,g=function(){if(!k.enabled)return!1;
var b=a(this);k.setstatus(b.data("idcomment"),b.data("moder"));return!1},m=litepubl.getuser().id;a(b.buttons,c).each(function(){var c=a(this),h=c.data("idcomment");if(b.ismoder){if(a(d).appendTo(c).data("idcomment",h).data("moder","approved").click(g),a(e).appendTo(c).data("idcomment",h).data("moder","hold").click(g),a(f).appendTo(c).data("idcomment",h).data("moder","delete").click(g),a(l).appendTo(c).data("idcomment",h).data("moder","edit").click(g),c.is(":hidden"))a('<button type="button">E</button>').insertBefore(c).one("click",
function(){a(this).next().show();a(this).remove();return!1})}else if(parseInt(c.data("idauthor"))==m&&(b.canedit&&a(l).appendTo(c).data("idcomment",h).data("moder","edit").click(g),b.candelete&&a(f).appendTo(c).data("idcomment",h).data("moder","delete").click(g),(b.canedit||b.candelete)&&c.is(":hidden")))a('<button type="button">E</button>').insertBefore(c).one("click",function(){a(this).next().show();a(this).remove();return!1});k.onbuttons.fire(c)})}});a(m).ready(function(){litepubl.getuser().id&&
litepubl.newinstance("moderate",litepubl.Moderate)})})(jQuery,document,window);
