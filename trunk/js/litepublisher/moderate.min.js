(function(b,h,m){litepubl.Moderate=Class.extend({enabled:!0,init:function(c){this.options=b.extend({comments:"#commentlist",hold:"#holdcommentlist",comment:"#comment-",content:"#commentcontent-",buttons:".moderationbuttons",button:'<button type="button" class="button"><span>%%title%%</span></button>',form:"#commentform"},ltoptions.theme.comments,c);this.onbuttons=b.Callbacks();b(".loadhold").click(this.loadhold);var a=this;m.setTimeout(function(){a.create_buttons(a.options.comments+", "+a.options.hold)},
20)},setenabled:function(c){c!=this.enabled&&((this.enabled=c)?b(this.options.buttons).show():b(this.options.buttons).hide())},getarea:function(){return b("textarea:first",this.options.form)},error:function(c){this.setenabled(!0);b.messagebox(lang.dialog.error,c)},setstatus:function(c,a){var d=this,e=this.options,f=e.comment+c;switch(a){case "delete":case "del":this.setenabled(!1);b.confirmbox(lang.dialog.confirm,lang.comments.confirmdelete,lang.comments.yesdelete,lang.comments.nodelete,function(a){if(0!=
a)return d.setenabled(!0);b.jsonrpc({type:"get",method:"comment_delete",params:{id:c},callback:function(a){if(!1==a)return d.error(lang.comments.notdeleted);b(f).remove();d.setenabled(!0)},error:function(b,a){d.error(lang.comments.notdeleted)}})});break;case "hold":case "approved":case "approve":this.setenabled(!1);b.jsonrpc({type:"get",method:"comment_setstatus",params:{id:c,status:"hold"==a?"hold":"approved"},callback:function(g){try{if(!1==g)return d.error(lang.comments.notmoderated);b("hold"==
a?e.hold:e.comments).append(b(e.comment+c));d.setenabled(!0)}catch(f){erralert(f)}},error:function(b,a){d.error(lang.comments.notmoderated)}});break;case "edit":this.setenabled(!1);b.jsonrpc({type:"get",method:"comment_getraw",params:{id:c},callback:function(b){try{d.edit(c,b.rawcontent)}catch(a){erralert(a)}},error:function(b,a){d.error(lang.comments.errorrecieved)}});break;default:alert("Unknown status "+a)}},edit:function(c,a){var d=this.getarea();d.data("idcomment",c).data("savedtext",d.val()).val(a).focus();
b.onEscape(this.restore_submit);var e=this,f=b(this.options.form);f.off("submit.confirmcomment").on("submit.moderate",function(){try{var a=b.trim(d.val());if(""==a)return e.enabled=!0,e.error(lang.comment.emptycontent),e.enabled=!1;b(":input",f).attr("disabled","disabled");b.jsonrpc({method:"comment_edit",params:{id:d.data("idcomment"),content:a},callback:function(a){try{b(":input",f).removeAttr("disabled");var c=e.options.content+a.id;b(c).html(a.content);e.restore_submit();location.hash=c.substring(1)}catch(d){erralert(d)}},
error:function(a,c){b(":input",f).removeAttr("disabled");e.error(lang.comments.notedited);e.restore_submit()}})}catch(c){erralert(c)}return!1})},restore_submit:function(){var c=this.getarea();c.val(c.data("savedtext"));this.setenabled(!0);b(this.options.form).off("submit.moderate").on("submit.confirmcomment",function(){if("confirmcomment"in litepubl)return litepubl.confirmcomment.submit()})},loadhold:function(){var c=this,a=this.options;b(".loadhold").parent().remove();b.jsonrpc({type:"get",method:"comments_get_hold",
params:{idpost:ltoptions.idpost},callback:function(d){try{if(a.ismoder){for(var e=b(a.comments),f=b(a.hold);e.next()[0]!=f[0];)e.next().remove();f.remove()}b(a.comments).after(d.items);c.create_buttons(a.hold)}catch(g){erralert(g)}},error:function(b,a){c.error(lang.comments.errorrecieved)}});return!1},create_buttons:function(c){var a=this.options,d={approve:"",hold:"",del:"",edit:""},e;for(e in d)d[e]=b.simpletml(a.button,{title:lang.comments[e],name:e});var f=b.simpletml(a.button,{title:"E",name:"show"}),
g=this,k=function(){if(!g.enabled)return!1;var a=b(this);g.setstatus(a.data("idcomment"),a.data("moder"));return!1},h=litepubl.getuser().id;b(a.buttons,c).each(function(){var c=b(this),e=c.data("idcomment");if(a.ismoder){for(var l in d)b(d[l]).appendTo(c).data("idcomment",e).data("moder",l).click(k);c.is(":hidden")&&g.addswitcher(c,f)}else parseInt(c.data("idauthor"))==h&&(a.canedit&&b(d.edit).appendTo(c).data("idcomment",e).data("moder","edit").click(k),a.candelete&&b(d.del).appendTo(c).data("idcomment",
e).data("moder","delete").click(k),(a.canedit||a.candelete)&&c.is(":hidden")&&g.addswitcher(c,f));g.onbuttons.fire(c)})},addswitcher:function(c,a){b(a).insertBefore(c).one("click mouseenter",function(){b(this).next().show();b(this).remove();return!1})}});b(h).ready(function(){litepubl.getuser().id&&classes.create({moderate:litepubl.Moderate})})})(jQuery,document,window);
