(function(b,k,g){b(k).ready(function(){litepubl.ulogin=new litepubl.Ulogin});litepubl.Ulogin=Class.extend({registered:!1,logged:!1,script:!1,dialogopened:!1,html:'<div><p>%%lang.subtitle%%</p><div id="ulogin-dialog"><div id="ulogin-holder" data-ulogin="display=small;fields=first_name,last_name;optional=email,phone,nickname;providers=vkontakte,odnoklassniki,mailru,yandex,facebook,google,twitter;hidden=other;redirect_uri=%%redirurl%%;%%callback%%"></div></div><div><a href="%%url%%" id="email-login">%%lang.emaillogin%%</a></div></div>',
init:function(){this.registered=litepubl.getuser().pass?1:0;if(!this.registered){var a=this;b('a[href^="'+ltoptions.url+'/admin/"], a[href^="/admin/"]').click(function(){var c=b(this).attr("href");litepubl.is_admin_url(c)&&a.open(c);return!1});b("#ulogin-comment-button").click(function(){a.onlogin({method:"comments_get_logged",idpost:ltoptions.idpost},function(c){"object"===typeof c&&("error"in c?b.messagebox(lang.dialog.error,c.error):"mesg"in c&&b("#before-commentform").html(c.mesg))});return!1})}},
open:function(a,c,d){if(this.dialogopened)return!1;set_cookie("backurl",a);var e=this;e.ready(function(){e.dialogopened=!0;var h=a?a:ltoptions.url+"/admin/login/?backurl="+encodeURIComponent(location.href),f=e.html.replace(/%%lang.emaillogin%%/gim,lang.ulogin.emaillogin).replace(/%%lang.subtitle%%/gim,lang.ulogin.subtitle).replace(/%%url%%/gim,h);b.isFunction(c)?(f=f.replace(/%%callback%%/gim,"callback=ulogincallback").replace(/%%redirurl%%/gim,""),g.ulogincallback=function(a){b.closedialog();try{c(a),
litepubl.stat("ulogin_token")}catch(e){erralert(e)}}):f=f.replace(/%%callback%%/gim,"").replace(/%%redirurl%%/gim,encodeURIComponent(ltoptions.url+"/admin/ulogin.php?backurl="+encodeURIComponent(h)));b.litedialog({title:lang.ulogin.title,html:f,width:300,close:function(){e.dialogopened=!1;litepubl.stat("ulogin_close")},open:function(){uLogin.customInit("ulogin-holder");b.isFunction(d)||(d=function(){g.location=a});b("#email-login").click(function(){b.closedialog(function(){"emailauth"in litepubl||
(litepubl.emailauth=new litepubl.Emailauth);litepubl.emailauth.open(d)});return!1});litepubl.stat("ulogin_open")},buttons:[{title:lang.dialog.close,click:b.closedialog}]})})},ready:function(a){return this.script?this.script.done(a):this.script=b.load_script("//ulogin.ru/js/ulogin.js",a)},auth:function(a,c,d){var e=this;return b.litejsonpost({method:"ulogin_auth",token:a,callback:c?c:!1},function(a){litepubl.user=a;set_cookie("litepubl_user_id",a.id);set_cookie("litepubl_user",a.pass);set_cookie("litepubl_regservice",
a.regservice);e.registered=!0;e.logged=!0;b.isFunction(d)&&d("callback"in a?a.callback:void 0)})},login:function(a,c,b){var e=this;e.open(a,function(a){e.auth(a,c,b)},b)},logon:function(a,c){var d=this;d.open("",function(b){d.auth(b,a,c)},function(){a?b.litejsonpost(a,c):c()})},onlogin:function(a,c){if(!this.registered)return this.logon(a,c);var d=this;if(this.logged)if(a)b.litejsonpost(a,c);else return c("logged"),!0;else b.litejson({method:"check_logged",callback:a?a:!1},function(b){"true"==b.result?
(d.logged=!0,c("callback"in b?b.callback:void 0)):d.logon(a,c)}),litepubl.stat("ulogin_checklogged");return!1}})})(jQuery,document,window);
