(function(b,k,g){b(k).ready(function(){litepubl.ulogin=new litepubl.Ulogin});litepubl.Ulogin=Class.extend({registered:!1,script:!1,dialogopened:!1,html:'<div><p>%%lang.subtitle%%</p><div id="ulogin-dialog"><div id="ulogin-holder" data-ulogin="display=small;fields=first_name,last_name;optional=email,phone,nickname;providers=vkontakte,odnoklassniki,mailru,yandex,facebook,google,twitter;hidden=other;redirect_uri=%%redirurl%%;%%callback%%"></div></div><div><a href="%%url%%" id="email-login">%%lang.emaillogin%%</a></div></div>',
init:function(){this.registered=litepubl.getuser().pass?1:0;if(!this.registered){var a=this;b('a[href^="'+ltoptions.url+'/admin/"], a[href^="/admin/"]').click(function(){var d=b(this).attr("href");litepubl.is_admin_url(d)&&a.open(d);return!1});b("#ulogin-comment-button").click(function(){a.open(location.href);return!1})}},open:function(a,d,c){if(this.dialogopened)return!1;set_cookie("backurl",a);var e=this;e.ready(function(){e.dialogopened=!0;var h=a?a:ltoptions.url+"/admin/login/?backurl="+encodeURIComponent(location.href),
f=e.html.replace(/%%lang.emaillogin%%/gim,lang.ulogin.emaillogin).replace(/%%lang.subtitle%%/gim,lang.ulogin.subtitle).replace(/%%url%%/gim,h);b.isFunction(d)?(f=f.replace(/%%callback%%/gim,"callback=ulogincallback").replace(/%%redirurl%%/gim,""),g.ulogincallback=function(a){b.closedialog();try{d(a)}catch(c){erralert(c)}}):f=f.replace(/%%callback%%/gim,"").replace(/%%redirurl%%/gim,encodeURIComponent(ltoptions.url+"/admin/ulogin.php?backurl="+encodeURIComponent(h)));b.litedialog({title:lang.ulogin.title,
html:f,width:300,close:function(){e.dialogopened=!1},open:function(){uLogin.customInit("ulogin-holder");b.isFunction(c)||(c=function(){g.location=a});b("#email-login").click(function(){b.closedialog(function(){litepubl.emailauth.open(c)});return!1})},buttons:[{title:lang.dialog.close,click:b.closedialog}]})})},ready:function(a){return this.script?this.script.done(a):this.script=b.load_script("http://ulogin.ru/js/ulogin.js",a)},auth:function(a,d,c){var e=this;return b.litejsonpost({method:"ulogin_auth",
token:a,callback:d?d:!1},function(a){litepubl.user=a;set_cookie("litepubl_user_id",a.id);set_cookie("litepubl_user",a.pass);set_cookie("litepubl_regservice",a.regservice);e.registered=!0;b.isFunction(c)&&(a.callback?c(a.callback):c())})},login:function(a,b,c){var e=this;e.open(a,function(a){e.auth(a,b,c)},c)},onlogin:function(a,d){var c=this;c.open("",function(b){c.auth(b,a,d)},function(){b.litejsonpost(a,d)})}})})(jQuery,document,window);
