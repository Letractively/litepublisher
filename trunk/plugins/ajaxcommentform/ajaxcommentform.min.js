var commentform={fields:["name","email","url"],subscribed:[],unsubscribed:[],error_dialog:!1,confirm_dialog:!1,get:function(a){return $("input[name='"+a+"']","#commentform").val()},set:function(a,b){$("input[name='"+a+"']","#commentform").val(b)},find:function(a){return"content"==a?$("textarea[name='content']","#commentform"):$("input[name='"+a+"']","#commentform")},init_field:function(a){var b=get_cookie("comuser_"+a);if(!b)return!1;this.set(a,b);return!0},init_subscribe:function(){var a="string"==
typeof ltoptions.idpost?ltoptions.idpost:ltoptions.idpost.toString();this.subscribed=get_cookie("comuser_subscribed").split(",");this.unsubscribed=get_cookie("comuser_unsubscribed").split(",");0<=$.inArray(a,this.subscribed)?$("input[name='subscribe']").attr("checked",!0):0<=$.inArray(a,this.unsubscribed)&&$("input[name='subscribe']").attr("checked",!1)},update_subscribe:function(){var a="string"==typeof ltoptions.idpost?ltoptions.idpost:ltoptions.idpost.toString();$("input[name='subscribe']").attr("checked")?
(-1==$.inArray(a,this.subscribed)&&this.subscribed.unshift(a),this.unsubscribed=$.grep(this.unsubscribed,function(b){return b!=a})):(-1==$.inArray(a,this.unsubscribed)&&this.unsubscribed.unshift(a),this.subscribed=$.grep(this.subscribed,function(b){return b!=a}));set_cookie("comuser_subscribed",this.subscribed.join(","));set_cookie("comuser_unsubscribed",this.unsubscribed.join(","))},init:function(){$("#comment").keydown(function(a){a.ctrlKey&&(13==a.keyCode||10==a.keyCode)&&$("#commentform").submit()});
$("#commentform").submit(commentform.submit);if(commentform.init_field("name"))commentform.init_field("email"),commentform.init_field("url"),commentform.init_subscribe();else{var a=get_cookie("userid");a&&$.get(ltoptions.url+"/ajaxcommentform.htm",{getuser:a,idpost:ltoptions.idpost},function(a){a=$.parseJSON(a);commentform.set("name",a.name);commentform.set("email",a.email);commentform.set("url",a.url);set_cookie("comuser_name",a.name);set_cookie("comuser_email",a.email);set_cookie("comuser_url",
a.url);$("input[name='subscribe']").attr("checked",a.subscribe);commentform.update_subscribe()})}},set_cookie:function(a){set_cookie("comuser_"+a,this.get(a))},error:function(a,b){$.load_ui(function(){commentform.error_dialog||(commentform.error_dialog=$('<div class="ui-helper-hidden" title="'+ltoptions.commentform.error_title+'"><h4></h4></div>').appendTo($("input[name='name']").closest("form")));$("h4",commentform.error_dialog).text(a);$(commentform.error_dialog).dialog({autoOpen:!0,modal:!0,buttons:[{text:"Ok",
click:function(){$(this).dialog("close");b&&commentform.find(b).focus()}}]})})},confirm:function(a){$.load_ui(function(){commentform.confirm_dialog||(commentform.confirm_dialog=$('<div class="ui-helper-hidden" title="'+a.title+'"><h4>'+a.title+"</h4></div>").appendTo($("input[name='name']").closest("form")));$(commentform.confirm_dialog).dialog({autoOpen:!0,modal:!0,buttons:[{text:lang.comment.robot,click:function(){$(this).dialog("close")}},{text:lang.comment.human,click:function(){$(this).dialog("close");
commentform.sendconfirm(a.confirmid)}}]})})},empty:function(a){return""==$.trim(this.get(a))?(this.error(lang.comment.emptyname,a),!0):!1},validemail:function(){return!/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/.test(this.get("email"))?(this.error(lang.comment.invalidemail,"email"),!1):!0},validate:function(){return this.empty("name")||this.empty("email")||!this.validemail()?!1:""==$.trim(this.find("content").val())?(this.error(lang.comment.emptycontent,"content"),!1):!0},submit:function(){if(!commentform.validate())return!1;
commentform.set_cookie("name");commentform.set_cookie("email");commentform.set_cookie("url");commentform.update_subscribe();commentform.send();return!1},send:function(){var a=$("input[name='name']").closest("form"),b={};$("input, textarea, checkbox",a).each(function(){b[$(this).attr("name")]=$(this).val();$(this).attr("disabled",!0)});$.post(ltoptions.url+"/ajaxcommentform.htm",b,function(a){try{var b=$.parseJSON(a);switch(b.code){case "confirm":commentform.confirm(b);break;case "success":commentform.success(b);
break;default:commentform.error(b.msg,!1)}}catch(e){commentform.error(e.message,!1)}}).error(function(a){commentform.error(a,!1)}).complete(function(){$("input, textarea, checkbox",a).attr("disabled",!1)})},sendconfirm:function(a){$.post(ltoptions.url+"/ajaxcommentform.htm",{confirmid:a},function(a){try{var c=$.parseJSON(a);switch(c.code){case "success":commentform.success(c);break;default:commentform.error(c.msg,!1)}}catch(d){commentform.error(d.message,!1)}}).error(function(a){commentform.error(a,
!1)})},success:function(a){set_cookie("userid",a.userid);window.location=a.posturl}};$(document).ready(commentform.init);
