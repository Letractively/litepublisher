(function(b){b.fileman={items:{},curr:[],indialog:!1,init:function(c){try{this.init_templates(),b(c).html(this.templates.tabs),b("#posteditor-files-tabs").tabs({cache:!0,select:function(a,c){"empty"==b(c.panel).data("files")&&b.fileman.loadpage(c.panel,b(c.panel).data("page"))}}),this.load_current_files(),ltoptions.swfu=createswfu(b.fileman.uploaded),b("form:first").submit(function(){b("input[name='files']").val(b.fileman.curr.join(","))})}catch(a){alert("error "+a.message)}},init_templates:function(){var c=
{lang:lang.posteditor,iconurl:ltoptions.files+"/js/litepublisher/icons/"},a;for(a in this.templates)this.templates[a]=b.simpletml(this.templates[a],c)},load_current_files:function(){b.litejson({method:"files_getpost",idpost:ltoptions.idpost},function(c){try{b.fileman.set_uploaded(c)}catch(a){alert("error "+a.message)}}).fail(function(c){b.messagebox(lang.dialog.error,c.responseText)})},set_uploaded:function(c){"fileperm"in c&&b("#posteditor-fileperms").html(c.fileperm);this.set_tabs_count(c.count);
for(var a in c.files)this.curr.push(a),this.items[a]=c.files[a];this.setpage("#current-files",c.files);this.setpage("#new-files",{})},set_tabs_count:function(c){if(!(1>c))for(var a=b("#posteditor-files-tabs"),d=1;d<=c;d++)b(this.templates.tab.replace("{{index}}",d)).appendTo(a).data("page",d).data("files","empty"),a.tabs("add","#filepage-"+d,d)},setpage:function(c,a){var d=b(c),e;for(e in a)0==parseInt(a[e].parent)&&d.append(this.get_fileitem(e));this.setborders(d);d.on("click",".file-toolbar a",
function(){var a=b(this).closest(".file-item"),c=a.data("idfile");switch(b(this).attr("class")){case "add-toolbutton":b.fileman.add(c);break;case "delete-toolbutton":b.fileman.del(c,a);break;case "property-toolbutton":b.fileman.editprops(c,a)}return!1});d.on("click","a.file-image",function(){var a=b(this);b.prettyPhoto.open(a.attr("href"),a.attr("title"),b("img",a).attr("alt"));return!1})},get_fileitem:function(c){var a=this.items[c];a.link=ltoptions.files+"/files/"+a.filename;type=a.media in this.templates?
a.media:"file";a.previewlink="";0!=parseInt(a.preview)&&a.preview in this.items&&(a.previewlink=ltoptions.files+"/files/"+this.items[a.preview].filename);a=b.simpletml(this.templates.item,{id:a.id,content:b.simpletml(this.templates[type],a)});return b(a).data("idfile",c)},loadpage:function(c,a){b(c).data("files","loading");b.litejson({method:"files_getpage",page:a-1},function(a){b.fileman.joinitems(a.files);b.fileman.setpage(c,a.files)}).fail(function(a){b.messagebox(lang.dialog.error,a.responseText)})},
joinitems:function(b){for(var a in b)this.items[a]=b[a]},uploaded:function(c,a){try{var d=b.parseJSON(a),e=d.id;b.fileman.curr.push(e);b.fileman.items[e]=d.item;0!=d.item.preview&&(b.fileman.items[d.preview.id]=d.preview);b("#current-files").append(b.fileman.get_fileitem(e));b("#new-files").append(b.fileman.get_fileitem(e))}catch(f){alert("error "+f.message)}},setborders:function(c){var a=b(".file-item",c);if(0!=a.length){a.removeClass("border-left");var d=b(".file-item:first",c).position();a.each(function(){var a=
b(this);a.position().left==d.left&&a.addClass("border-left")})}},add:function(c){0<=b.inArray(c,this.curr)||(this.curr.push(c),this.setborders(b("#current-files").append(this.get_fileitem(c))))},del:function(c,a){var d=b.inArray(c,this.curr);0>d||(delete this.curr[d],d=a.parent(),a.remove(),this.setborders(d))},editprops:function(c,a){if(this.indialog)return!1;this.indialog=!0;var d=this.items[c];b.prettyPhotoDialog({title:lang.posteditor.property,html:this.templates.fileprops,open:function(a){b("input[name='fileprop-title']",
a).val(d.title);b("input[name='fileprop-description']",a).val(d.description);b("input[name='fileprop-keywords']",a).val(d.keywords)},buttons:[{title:"Ok",click:function(){var d=b(".pp_inline"),f=b.trim(b("input[name='fileprop-title']",d).val()),g=b.trim(b("input[name='fileprop-description']",d).val()),d=b.trim(b("input[name='fileprop-keywords']",d).val());b.prettyPhoto.close();b.fileman.setprops(c,f,g,d,a)}},{title:lang.dialog.cancel,click:function(){b.prettyPhoto.close();b.fileman.indialog=!1}}]})},
setprops:function(c,a,d,e,f){b.litejsontype("post",{method:"files_setprops",idfile:c,title:a,description:d,keywords:e},function(a){b.fileman.items[a.item.id]=a.item;f.replaceWith(b.fileman.get_fileitem(c));b.fileman.indialog=!1}).fail(function(a){b.fileman.indialog=!1;b.messagebox(lang.dialog.error,a.responseText)})}}})(jQuery);
