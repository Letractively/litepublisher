(function(c){litepubl.Fileman=Class.extend({items:{},curr:[],indialog:!1,init:function(b){try{this.init_templates();var a=this;c(b).html(this.tml.tabs);c("#posteditor-files-tabs").tabs({cache:!0,select:function(b,d){"empty"==c(d.panel).data("files")&&a.loadpage(d.panel,c(d.panel).data("page"))}});this.load_current_files();c("form:first").submit(function(){c("input[name='files']").val(a.curr.join(","))});this.init_upload()}catch(d){alert("error "+d.message)}},init_templates:function(){this.tml=litepubl.tml.fileman;
c.replacetml(litepubl.tml.fileman,{lang:lang.posteditor,iconurl:ltoptions.files+"/js/litepublisher/icons/"})},init_upload:function(){var b=this;this.uploader=new litepubl.Uploader;this.uploader.onupload=function(a,c){b.uploaded(a,c)}},load_current_files:function(){var b=this;c.litejson({method:"files_getpost",idpost:ltoptions.idpost},function(a){try{b.set_uploaded(a)}catch(c){alert("error "+c.message)}}).fail(function(a){c.messagebox(lang.dialog.error,a.responseText)})},set_uploaded:function(b){"fileperm"in
b&&c("#posteditor-fileperms").html(b.fileperm);this.set_tabs_count(b.count);for(var a in b.files)this.curr.push(a),this.items[a]=b.files[a];this.setpage("#current-files",b.files);this.setpage("#new-files",{})},set_tabs_count:function(b){if(!(1>b))for(var a=c("#posteditor-files-tabs"),d=1;d<=b;d++)c(this.tml.tab.replace("{{index}}",d)).appendTo(a).data("page",d).data("files","empty"),a.tabs("add","#filepage-"+d,d)},setpage:function(b,a){var d=c(".file-items",b),e;for(e in a)0==parseInt(a[e].parent)&&
d.append(this.get_fileitem(e));this.setborders(d);var f=this;d.on("click.toolbar",".file-toolbar a",function(){var a=c(this).closest(".file-item"),b=a.data("idfile");switch(c(this).attr("class")){case "add-toolbutton":f.add(b);break;case "delete-toolbutton":f.del(b,a);break;case "property-toolbutton":f.editprops(b,a)}return!1});d.on("click.image","a.file-image",function(){f.openimage(c(this));return!1})},openimage:function(b){c.prettyPhoto.open(b.attr("href"),b.attr("title"),c("img",b).attr("alt"))},
get_fileitem:function(b){var a=this.items[b];a.link=ltoptions.files+"/files/"+a.filename;type=a.media in this.tml?a.media:"file";a.previewlink="";0!=parseInt(a.preview)&&a.preview in this.items&&(a.previewlink=ltoptions.files+"/files/"+this.items[a.preview].filename);a=c.simpletml(this.tml.item,{id:a.id,content:c.simpletml(this.tml[type],a)});return c(a).data("idfile",b)},loadpage:function(b,a){var d=this;c(b).data("files","loading");c.litejson({method:"files_getpage",page:a-1},function(a){d.joinitems(a.files);
d.setpage(b,a.files)}).fail(function(a){c.messagebox(lang.dialog.error,a.responseText)})},joinitems:function(b){for(var a in b)this.items[a]=b[a]},uploaded:function(b,a){try{var d=a.id;this.curr.push(d);this.items[d]=a.item;0!=a.item.preview&&(this.items[a.preview.id]=a.preview);c("#current-files .file-items").append(this.get_fileitem(d));c("#new-files .file-items").append(this.get_fileitem(d))}catch(e){alert("error "+e.message)}},setborders:function(b){var a=c(".file-item",b);if(0!=a.length){a.removeClass("border-left");
var d=c(".file-item:first",b).position();a.each(function(){var a=c(this);a.position().left==d.left&&a.addClass("border-left")})}},add:function(b){0<=c.inArray(b,this.curr)||(this.curr.push(b),this.setborders(c("#current-files .file-items").append(this.get_fileitem(b))))},del:function(b,a){var d=c.inArray(b,this.curr);0>d||(delete this.curr[d],d=a.parent(),a.remove(),this.setborders(d))},editprops:function(b,a){if(this.indialog)return!1;this.indialog=!0;var d=this.items[b],e=this;c.prettyPhotoDialog({title:lang.posteditor.property,
html:this.tml.fileprops,open:function(a){c("input[name='fileprop-title']",a).val(d.title);c("input[name='fileprop-description']",a).val(d.description);c("input[name='fileprop-keywords']",a).val(d.keywords)},buttons:[{title:"Ok",click:function(){var d=c(".pp_inline"),d={title:c.trim(c("input[name='fileprop-title']",d).val()),description:c.trim(c("input[name='fileprop-description']",d).val()),keywords:c.trim(c("input[name='fileprop-keywords']",d).val())};c.prettyPhoto.close();e.setprops(b,d,a)}},{title:lang.dialog.cancel,
click:function(){c.prettyPhoto.close();e.indialog=!1}}]})},setprops:function(b,a,d){this.items[b]=c.extend(a,this.items[b]);a.method="files_setprops";a.idfile=b;var e=this;return c.litejsonpost(a,function(a){e.items[a.item.id]=a.item;d&&d.replaceWith(e.get_fileitem(b));e.indialog=!1}).fail(function(a){e.indialog=!1;c.messagebox(lang.dialog.error,a.responseText)})}})})(jQuery,document,window);
