var commentform={fields:["name","email","url"],subscribed:[],unsubscribed:[],error_dialog:false,confirm_dialog:false,get:function(a){return $("input[name='"+a+"']","#commentform").val()},set:function(a,b){$("input[name='"+a+"']","#commentform").val(b)},find:function(a){if(a=="content"){return $("textarea[name='content']","#commentform")}return $("input[name='"+a+"']","#commentform")},init_field:function(a){var b=get_cookie("comuser_"+a);if(!b){return false}this.set(a,b);return true},init_subscribe:function(){var a=typeof ltoptions.idpost=="string"?ltoptions.idpost:ltoptions.idpost.toString();this.subscribed=get_cookie("comuser_subscribed").split(",");this.unsubscribed=get_cookie("comuser_unsubscribed").split(",");if($.inArray(a,this.subscribed)>=0){$("input[name='subscribe']").attr("checked",true)}else{if($.inArray(a,this.unsubscribed)>=0){$("input[name='subscribe']").attr("checked",false)}}},update_subscribe:function(){var a=typeof ltoptions.idpost=="string"?ltoptions.idpost:ltoptions.idpost.toString();if($("input[name='subscribe']").attr("checked")){if($.inArray(a,this.subscribed)==-1){this.subscribed.unshift(a)}this.unsubscribed=$.grep(this.unsubscribed,function(b){return b!=a})}else{if($.inArray(a,this.unsubscribed)==-1){this.unsubscribed.unshift(a)}this.subscribed=$.grep(this.subscribed,function(b){return b!=a})}set_cookie("comuser_subscribed",this.subscribed.join(","));set_cookie("comuser_unsubscribed",this.unsubscribed.join(","))},init:function(){$("#comment").keydown(function(b){if(b.ctrlKey&&((b.keyCode==13)||(b.keyCode==10))){$("#commentform").submit()}});$("#commentform").submit(commentform.submit);if(commentform.init_field("name")){commentform.init_field("email");commentform.init_field("url");commentform.init_subscribe()}else{var a=get_cookie("userid");if(!a){return}$.get(ltoptions.url+"/ajaxcommentform.htm",{getuser:a,idpost:ltoptions.idpost},function(c){var b=$.parseJSON(c);commentform.set("name",b.name);commentform.set("email",b.email);commentform.set("url",b.url);set_cookie("comuser_name",b.name);set_cookie("comuser_email",b.email);set_cookie("comuser_url",b.url);$("input[name='subscribe']").attr("checked",b.subscribe);commentform.update_subscribe()})}},set_cookie:function(a){set_cookie("comuser_"+a,this.get(a))},error:function(b,a){$.load_ui(function(){if(!commentform.error_dialog){commentform.error_dialog=$('<div class="ui-helper-hidden" title="'+ltoptions.commentform.error_title+'"><h4></h4></div>').appendTo($("input[name='name']").closest("form"))}$("h4",commentform.error_dialog).text(b);$(commentform.error_dialog).dialog({autoOpen:true,modal:true,buttons:[{text:"Ok",click:function(){$(this).dialog("close");if(a){commentform.find(a).focus()}}}]})})},confirm:function(a){$.load_ui(function(){if(!commentform.confirm_dialog){commentform.confirm_dialog=$('<div class="ui-helper-hidden" title="'+a.title+'"><h4>'+a.title+"</h4></div>").appendTo($("input[name='name']").closest("form"))}$(commentform.confirm_dialog).dialog({autoOpen:true,modal:true,buttons:[{text:lang.comment.robot,click:function(){$(this).dialog("close")}},{text:lang.comment.human,click:function(){$(this).dialog("close");commentform.sendconfirm(a.confirmid)}}]})})},empty:function(a){if(""==$.trim(this.get(a))){this.error(lang.comment.emptyname,a);return true}return false},validemail:function(){var a=/^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;if(!a.test(this.get("email"))){this.error(lang.comment.invalidemail,"email");return false}return true},validate:function(){if(this.empty("name")||this.empty("email")||!this.validemail()){return false}if(""==$.trim(this.find("content").val())){this.error(lang.comment.emptycontent,"content");return false}return true},submit:function(){if(!commentform.validate()){return false}commentform.set_cookie("name");commentform.set_cookie("email");commentform.set_cookie("url");commentform.update_subscribe();commentform.send();return false},send:function(){var b=$("input[name='name']").closest("form");var a={};$("input, textarea, checkbox",b).each(function(){a[$(this).attr("name")]=$(this).val();$(this).attr("disabled",true)});$.post(ltoptions.url+"/ajaxcommentform.htm",a,function(f){try{var c=$.parseJSON(f);switch(c.code){case"confirm":commentform.confirm(c);break;case"success":commentform.success(c);break;default:commentform.error(c.msg,false);break}}catch(d){commentform.error(d.message,false)}}).error(function(c){commentform.error(c,false)}).complete(function(){$("input, textarea, checkbox",b).attr("disabled",false)})},sendconfirm:function(a){$.post(ltoptions.url+"/ajaxcommentform.htm",{confirmid:a},function(d){try{var b=$.parseJSON(d);switch(b.code){case"success":commentform.success(b);break;default:commentform.error(b.msg,false);break}}catch(c){commentform.error(c.message,false)}}).error(function(b){commentform.error(b,false)})},success:function(a){set_cookie("userid",a.userid);window.location=a.posturl}};$(document).ready(commentform.init);